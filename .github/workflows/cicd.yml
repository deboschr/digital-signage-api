deploy:
  needs: build-and-push
  runs-on: ubuntu-latest
  steps:
    - name: SSH deploy with docker-compose
      uses: appleboy/ssh-action@v1.2.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          set -e
          cd /home/deboschr/digital-signage-cms/digital-signage-api

          # generate .env dari GitHub Secrets
          cat > .env <<EOF
          APP_ENV=${{ secrets.APP_ENV }}
          APP_PORT=${{ secrets.APP_PORT }}
          APP_HOST=${{ secrets.APP_HOST }}
          STATIC_PATH=${{ secrets.STATIC_PATH }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASS=${{ secrets.DB_PASS }}
          DB_NAME=${{ secrets.DB_NAME }}
          EOF

          # pull & restart service
          docker compose pull
          docker compose up -d

          # bersihkan image lama
          docker image prune -f
